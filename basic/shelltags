#!/bin/bash

shelltags() {
	# needs to be the very first thing
	local EXITSTATUS="$?"

	# update with new attributes
	export PROMPT_COMMAND="shelltags $*"

	# save original prompt if necessary and clean it
	[ -z "$PS1_ORIGINAL" ] && PS1_ORIGINAL=$PS1
	PS1=

	# check and set parameters
	while getopts tesglfmb OPT; do
		case $OPT in
			t) PS1+="$(shelltags_tag 'time')";;
			e) PS1+="$(shelltags_tag 'error' $EXITSTATUS)";;
			s) PS1+="$(shelltags_tag 'screen')";;
			g) PS1+="$(shelltags_tag 'git')";;
			l) PS1+="$(shelltags_tag 'load')";;
			f) PS1+="$(shelltags_tag 'freespace')";;
			m) PS1+="$(shelltags_tag 'temperature')";;
			b) PS1+="$(shelltags_tag 'battery')";;
		esac
	done
	shift $((OPTIND-1))
	OPTIND=0

	local ACPIINFO="$(acpi -V 2> /dev/null)"

	PS1+=$PS1_ORIGINAL
}

shelltags_tag() {
	local COLOR=
	local OUTPUT=

	# checks
	case $1 in
		temperature|battery)
			[ -z "$(whereis acpi | cut -d: -f2-)" ] && return
			;;
	esac

	# execute tag
	case $1 in
		time)   COLOR=cyan;  OUTPUT="\A" ;;
		error)  COLOR=red;   [ "$2" != 0 ] && OUTPUT=$2 ;;
		screen) COLOR=green; OUTPUT=$(echo $STY | cut -d. -f2) ;;

		load)
			COLOR=magenta
			local PROCESSOR=$(grep -c ^processor /proc/cpuinfo)
			local CURLOAD=$(cat /proc/loadavg | cut -d' ' -f1)
			local CURLOAD_INT=$(cat /proc/loadavg | cut -d'.' -f1)
			[ "$CURLOAD_INT" -ge "$PROCESSOR" ] && OUTPUT="$CURLOAD"
			;;

		freespace)
			COLOR=magenta
			if df > /dev/null 2>&1; then
				local FREE_SPACE=$(stat -f --printf="%a * %s\n" $PWD | bc)
				local CRITICAL=$(stat -f --printf="%b * %s * 0.1\n" $PWD | bc)
				local CRITICAL_INT=$(echo $CRITICAL | cut -d. -f1)
				[ "$FREE_SPACE" -gt "$CRITICAL_INT" ] && return

				if [ $FREE_SPACE > 1073741824 ]; then
					OUTPUT=$(( $FREE_SPACE / ( 1024**3 )))GB
				elif [ $FREE_SPACE > 1048576 ]; then
					OUTPUT=$(( $FREE_SPACE / ( 1024**2 )))MB
				elif [ $FREE_SPACE > 1024 ]; then
					OUTPUT=$(( $FREE_SPACE / ( 1024**1 )))KB
				else
					OUTPUT=${FREE_SPACE}B
				fi
			fi
			;;

		temperature)
			COLOR=magenta
			OUTPUT=$(acpi -t | cut -d' ' -f4- | sed 's/\.. degrees /°/')
			[ "$(echo $OUTPUT | cut -d° -f1)" -lt 70 ] && OUTPUT=
			;;

		battery)
			# support for multiple batteries (like Lenovo T460)
			COLOR=magenta
			OUTPUT=$(acpi -b | cut -d' ' -f4 | xargs | tr -d ,)
			[ "$(echo $OUTPUT | tr -d % | tr ' ' + | bc)" -ge "50" ] && OUTPUT=
			;;

		git)
			local GIT=$(git status --short --branch 2> /dev/null | grep '^##')
			local GITSTATE=
			if [ -n "$GIT" ]; then
				COLOR=blue
				OUTPUT=$(echo $GIT | cut -d' ' -f2 | sed 's/\.\.\..*$//g')
				GITSTATE=$(echo $GIT | awk 'NR>1{print $1}' RS=[ FS=])
				GITSTATE=${GITSTATE/behind /-}
				GITSTATE=${GITSTATE/ahead /+}
				GITSTATE=${GITSTATE/,/}
				[ -n "$GITSTATE" ] && OUTPUT+=" $GITSTATE"
				GITSTASH=$(git stash list 2> /dev/null | wc -l)
				[ "$GITSTASH" != 0 ] && OUTPUT+=" {$GITSTASH}"
			fi
			;;
	esac

	[ -z "$OUTPUT" ] && return

	case $COLOR in
		black)   COLOR=0;;
		red)     COLOR=1;;
		green)   COLOR=2;;
		yellow)  COLOR=3;;
		blue)    COLOR=4;;
		magenta) COLOR=5;;
		cyan)    COLOR=6;;
		white|*) COLOR=7;;
	esac

	local BG="\[\033[$(( $COLOR + 40 ))m\]"
	local FG="\[\033[1;$(( $COLOR + 30 ))m\]"
	local WH="\[\033[1;37m\]"
	local UN="\[\033[0m\]"

	echo -en "${BG}${FG}[${WH}${OUTPUT}${FG}]${UN} "
}

export PROMPT_COMMAND="shelltags $*"
