#!/bin/bash

BIN_DIR="$(cd $(dirname $0); pwd)"

# I always checkout the dotfiles repo in the same directory as the script one.
DOT_DIR="$(cd $BIN_DIR/$(dirname $(readlink $0) | sed 's/scripts/dotfiles/'); pwd)"

if ! test -d $DOT_DIR; then
	echo "There is no dotfiles directory. Cloning one..."
	git clone --recursive http://github.com/pfsmorigo/dotfiles.git $DOT_DIR
else
	cd $DOT_DIR
	git pull
fi

dotinstall() {
	if [ -e ~/.$1 ]; then
		if diff ~/.$1 $DOT_DIR/$1; then
			echo "Skipping $1..."
			return
		fi

		backup_file $1
	fi

	mkdir -p $(dirname ~/$1)

	echo "Linking $1...."
	cd ~; pwd; ln -sf "${DOT_DIR/$HOME\//}/$1" .$1
}

initial_dirs() {
	mkdir -p ~/log/screen
}

backup_file() {
	NEWFILE=$1.$(date +%F_%T)
	echo "Renaming $1 to $NEWFILE..."
	mv ~/$1 ~/$NEWFILE
}

setup_git() {
	GIT_FILE=$HOME/.gitconfig-userinfo
	if [ -f "$GIT_FILE" ]; then
		read -p "$GIT_FILE already exists. Overwrite? (y/n) " RESP
		if [ "$RESP" = "y" ]; then
			backup_file $GIT_FILE
		else
			return
		fi
	fi

	FULLNAME=$(getent passwd $LOGNAME | cut -d ":" -f 5)
	EMAIL="$LOGNAME@gmail.com"

	echo -n "Enter your full name [$FULLNAME]: "
	read NEWFULLNAME
	[ -n "$NEWFULLNAME" ] && FULLNAME=$NEWFULLNAME
	echo -n "Enter your email [$EMAIL]: "
	read NEWEMAIL
	[ -n "$NEWEMAIL" ] && EMAIL=$NEWEMAIL

	echo "[user]" > $GIT_FILE
	echo "    name = $FULLNAME" >> $GIT_FILE
	echo "    email = $EMAIL" >> $GIT_FILE
}

case $1 in
	deps|dependencies)
		install_dependencies
		;;

	clean)
		rm -f ~/.XCompose.*
		rm -f ~/.Xresources.*
		rm -f ~/.bash_profile.*
		rm -f ~/.bashrc.*
		rm -f ~/.gitconfig.*
		rm -f ~/.gtkrc-2.0.*
		rm -f ~/.i3.*
		rm -f ~/.screenrc.*
		rm -f ~/.taskrc.*
		rm -f ~/.vim.*
		rm -f ~/.vimrc.*
		rm -f ~/.rpmmacros.*
		;;

	*)
		initial_dirs
		dotinstall XCompose
		dotinstall Xresources
		dotinstall bash_profile
		dotinstall bashrc
		dotinstall gitconfig
		dotinstall gtkrc-2.0
		dotinstall i3
		dotinstall inputrc
		dotinstall screenrc
		dotinstall taskrc
		dotinstall vim
		dotinstall vimrc
		dotinstall rpmmacros
		setup_git
		;;
esac

