#!/bin/bash

NAME=URxvt
SERVER=$1
COMMAND='echo Hostname: $HOSTNAME; '
COMMAND+='~/.local/bin/screen_switch; '
COMMAND+='test $? -eq 127 && screen -AOxRR '$USER'; '
COMMAND+='test $? -eq 127 && bash; '
COMMAND+='test $? -ne 1 && sleep 10'

if [ "$1" = "gui" ]; then
	HOSTS="$(grep -v "^#" /etc/hosts | awk '{ print $2 }' | sort -u)"
	SSH_CONFIG="$(grep "^Host " ~/.ssh/config | awk '{ print $2 }' | grep -v '*' )"
	LIST=$(echo -e "$HOSTS $SSH_CONFIG" | sort -u)
	ANS=$(zenity --list --text='Pick a server' --column=servers local $LIST)
	[[ -n $ANS ]] && SERVER=$ANS || exit 1
fi

if [ -n "$SERVER" ] && [ "$SERVER" != "local" ]; then
	NAME+="Remote"
	grep -q ^${SERVER}$ ~/.ssh/mosh && SSH="mosh" || SSH="ssh -tY"
	COMMAND="$SSH $SERVER -- bash -c '$COMMAND'; echo exit code: $?; sleep 10"
fi

pgrep urxvtd > /dev/null || urxvtd --fork --opendisplay > /tmp/urxvtd.log 2>&1
set -xf
urxvtc -name $NAME -e sh -c "$COMMAND"
#urxvtc -name $NAME -e sh -c "export TERM='linux'; $PREFIX; sleep 100"
