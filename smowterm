#!/bin/bash

server_list()
{
	HOSTS="$(grep -v "^#" /etc/hosts | awk '{ print $2 }' | sort -u)"
	SSH_CONFIG="$(grep "^Host " ~/.ssh/config | awk '{ print $2 }' | grep -v '*' )"
	echo -e "$HOSTS\n$SSH_CONFIG" | sort -u
}

pick_server() {
	ANS=$(zenity --list --text='Pick a server' --column=servers local $(server_list))
	[[ -n $ANS ]] && $0 $ANS
	exit 0
}

connect() {
	SERVER=$1
	SCREEN_NAME=$2

	if [ "$SERVER" != "local" ]; then
		SSH="ssh -tY"

		SERVER_OPTIONS=$(grep "^$SERVER " ~/.smowterm | cut -d' ' -f2- | xargs)
		[[ "$SERVER_OPTIONS" =~ "mosh" ]] && SSH="mosh"

		PREFIX="$SSH $SERVER --"
	fi

	run_command $PREFIX bash ~/bin/smowscreen $SCREEN_NAME

	if [ $? != 0 ]; then
		[ -z "$SCREEN_NAME" ] && SCREEN_NAME=$USER
		run_command $PREFIX screen -AOxRR $SCREEN_NAME
	fi

	if [ $? != 0 ]; then
		run_command $PREFIX
	fi

	sleep 100
	exit 0
}

run_command() {
	echo -e "\n\033[0;33m[ $* ]\033[0m\n"
	$*
	return $?
}

while getopts ":bs" OPTION
do
	case $OPTION in
		b) NAME+="Big" ;;
		s) NAME+="Small" ;;
	esac
	shift $((OPTIND-1))
done

NAME="URxvt"

case $1 in
	gui) pick_server;;
	connect) connect $2 $3;;
	'') SERVER="local";;
	*)  SERVER="$1"; NAME+="Remote";;
esac

SCREEN_NAME=$2

if ! ps -ef | grep uraxvtd | grep -v grep 2>&1 > /dev/null; then
	urxvtd -q -f -o
fi

set -x
urxvtc -name $NAME -e sh -c "$0 connect $SERVER $SCREEN_NAME"

#urxvtc -name $NAME -e sh -c "$COMMAND; sleep 100"; sleep 100
#urxvtc -name $NAME -e sh -c "export TERM='linux'; $PREFIX; sleep 100"

sleep 10
